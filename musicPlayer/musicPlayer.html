<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>musicPlayer</title>
    <link rel="stylesheet" href="musicPlayer.css">
</head>
<body>
    <div class="onPlayingSection">
        <div id="video"></div><br />
        <div class="videoBtnSection">
            <button type="button" onclick="playYoutube()">Play</button>
            <button type="button" onclick="pauseYoutube()">Pause</button>
            <button type="button" onclick="stopYoutube()">Stop</button>
            <button type="button" onclick="nextYoutube()">Next</button>
        </div>
    </div>
    <div class="container">
        <div class="addbox" onclick="addBox()">+</div>
    </div>
    <!-- modal -->
    <div class="modal">
        <div class="modalContent">
            <span class="close">&times;</span>
            <h2>새로운 div 추가하기</h2>
            <form>
              <label for="title">Title:</label>
              <input type="text" class="title" name="title"><br><br>
              <label for="link">Link:</label>
              <input type="text" class="link" name="link"><br><br>
              <input type="button" id="submit" value="추가하기">
            </form>
        </div>
    </div>
    <script>
        const $container = document.querySelector(".container");
        const addEle = document.querySelector('.addbox');
        // Youtube API 
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        //새로고침 시 local stroage data 불러오기
        window.onload = function() {
            let savedData = JSON.parse(localStorage.getItem("boxData")) || [];
            for(let i=0; i<savedData.length; i++) {
                let outerDiv = document.createElement('div');
                outerDiv.setAttribute('class', 'box');
                outerDiv.setAttribute('draggable', 'true');
                outerDiv.innerHTML = `${savedData[i]}`;
                let deleteBtn = outerDiv.querySelector(".delete");
                deleteBtn.addEventListener('click',deleteBox)
                $container.insertBefore(outerDiv,addEle);

            }
        }

        /*
        onYouTubeIframeAPIReady 함수는 필수
        플레이어 API에 대한 JavaScript 다운로드 완료 시 API가 이 함수 호출
        페이지 로드 시 표시할 플레이어 개체.
         */
        let player;
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('video', {
                height: '400',            // <iframe> 태그 지정시 필요없음
                width: '800',             // <iframe> 태그 지정시 필요없음
                videoId: 'K4TOrB7at0Y',   // <iframe> 태그 지정시 필요없음
                playerVars: {             // <iframe> 태그 지정시 필요없음
                    controls: '2',
                    },
                events: {
                    // 'onReady': onPlayerReady,               // 플레이어 로드가 완료되고 API 호출을 받을 준비가 될 때마다 실행
                    'onStateChange': onPlayerStateChange    // 플레이어의 상태가 변경될 때마다 실행
                }
            });
        }

        function onPlayerReady (event) {
            // 준비되면 바로 시작
            // event.target.playVideo();
        }

        var done = false;
        function onPlayerStateChange(event) {

            if (event.data == YT.PlayerState.PLAYING && !done) {
                done = true;
            }
            if(event.data == YT.PlayerState.ENDED) {
                // let parent = document.querySelector(".container");
                let child = items[0];
                deleteLocalStorage(child)
                // const parentNode = child.parentNode;
                // const childs = parentNode.querySelectorAll('.box');
                // const divs = Array.from(childs);
                // const index = divs.indexOf(child);
                // console.log(index);
                // const boxData = JSON.parse(localStorage.getItem("boxData"));
                // delete boxData[index];
                // const filterArr = boxData.filter(item => item !== null || item!==undefined);
                // localStorage.setItem("boxData", JSON.stringify(filterArr));
                child.remove();
                player.loadVideoById(nextPlay());
                player.playVideo();
            }
        }

        function playYoutube () {
            player.playVideo();
        }
        function pauseYoutube () {
            player.pauseVideo();
        }
        function stopYoutube () {
            player.seekTo(0, true);     // 영상의 시간을 0초로 이동시킨다.
            player.stopVideo();
        }
        function nextYoutube () {
            let child = items[0];
            deleteLocalStorage(child)
            // const parentNode = child.parentNode;
            // const childs = parentNode.querySelectorAll('.box');
            // const divs = Array.from(childs);
            // const index = divs.indexOf(child);
            // console.log(index);
            // const boxData = JSON.parse(localStorage.getItem("boxData"));
            // delete boxData[index];
            // const filterArr = boxData.filter(item => item !== null || item!==undefined);
            // localStorage.setItem("boxData", JSON.stringify(filterArr));
            child.remove();
            player.loadVideoById(nextPlay());
            // player.cueVideoById(nextPlay());
            
        }

        let played = false;
        function collectPlayCount (data) {
            if (data == YT.PlayerState.PLAYING && played == false) {
                // todo statistics
                played = true;
            }
        }

        //Drag & Drop Playlist
        function handleDragStart(e) {
            this.style.opacity = '0.4';
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }
        function handleDragEnd(e) {
            this.style.opacity = '1';

            items.forEach(function (item) {
                item.classList.remove('over');
            });
        }
        function handleDragOver(e) {
            if (e.preventDefault) {
                    e.preventDefault();
            }

            return false;
        }
        function handleDragEnter(e) {
            this.classList.add('over');
        }
        function handleDragLeave(e) {
            this.classList.remove('over');
        }
        function handleDrop(e) {
            e.stopPropagation(); // stops the browser from redirecting.
            //dragSrcEl는 클릭했을 때 선언해서 내가 처음 클릭한 값이고
            // this는 drop과 함께 발생하여 도착지점 div의 this값으로, 도착지점의 값이다.
            // 그 두개는 다르므로 dragSrcEl.innerHTML(처음 세팅한 선택한 div의 값)의 값에는 도착지점의 값으로 들어가고
            // 첫 클릭에서 저장해 놓았던 div값(e.dataTransfer.setData('text/html', this.innerHTML);)
            // 이거를 받아와서 도착지점의 값으로 들어간다!
            if (dragSrcEl !== this) {
                dragSrcEl.innerHTML = this.innerHTML;
                this.innerHTML = e.dataTransfer.getData('text/html');
                addDeleteFunction();
                const childs = $container.querySelectorAll('.box');
                const test = Array.from(childs);
                let eleArr = [];
                for(let i=0; i<test.length;i++) {
                    let ele = test[i].innerHTML;
                    eleArr.push(ele);
                }
                console.log(eleArr);
                localStorage.clear();
                localStorage.setItem("boxData", JSON.stringify(eleArr));

            }
            //fail 일 경우 null 보다 확실한 값으로 알려주는게 좋아서.
            return false;
        }
        function addDeleteFunction() {
            const deleteBtns = document.querySelectorAll('.delete');
            deleteBtns.forEach((btn)=> {
                btn.addEventListener('click', deleteBox)
            })
        }

        // MutationObserver를 활용해서 childNode 변경을 감지하고, 감지하면 안에 함수 실행!
        let items;
        const observer = new MutationObserver(
            function(mutationList, observer) {
            for(let mutation of mutationList) {
                if(mutation.type === 'childList') {
                        items = document.querySelectorAll('.container .box');
                        items.forEach(function(item) {
                            item.addEventListener('dragstart', handleDragStart);
                            item.addEventListener('dragover', handleDragOver);
                            item.addEventListener('dragenter', handleDragEnter);
                            item.addEventListener('dragleave', handleDragLeave);
                            item.addEventListener('dragend', handleDragEnd);
                            item.addEventListener('drop', handleDrop);
                    });
                }
            }
        })
        observer.observe($container, {childList:true});

        let nowPlay;
        function nextPlay() {
            nowPlay = items[0].children[1].textContent;
            const videoId = nowPlay.match(/v=([^&]+)/)[1];
            return videoId;
        }

        //modal
        const modal = document.querySelector(".modal");
        const titleInput = modal.querySelector(".title");
        const linkInput = modal.querySelector(".link");
        const submitBtn = modal.querySelector("#submit");
        const closeBtn = modal.querySelector(".close");

        modal.style.display = 'none';
        function showModal() {
            modal.style.display = 'block';
        }
        function closeModal() {
            addBox();
            clearInput();
            modal.style.display = 'none';
        }
        function clearInput() {
            titleInput.value = "";
            linkInput.value = "";
        }

        // Add, delete playlist box
        function addBox() {
            let title = titleInput.value;
            let link = linkInput.value;
            const newDivEle = document.createElement('div');
            const newDivChildEle1 = document.createElement('div');
            const newDivChildEle2 = document.createElement('div');
            const newDivChildEle3 = document.createElement('div');
            newDivEle.setAttribute('class', 'box');
            newDivEle.setAttribute('draggable','true');
            newDivChildEle1.setAttribute('class', 'title');
            newDivChildEle2.setAttribute('class', 'link');
            newDivChildEle3.setAttribute('class', 'delete');
            newDivChildEle1.textContent = title;
            newDivChildEle2.textContent = link;
            newDivChildEle2.style.display = 'none';
            newDivChildEle3.textContent = 'delete';
            newDivChildEle3.addEventListener('click', deleteBox);
            // newDivChildEle2.innerHTML = prompt("유튜브 링크 입력");
            if ( newDivChildEle2.innerHTML === '') {
                return;
            }   else if(!newDivChildEle2.innerHTML.startsWith("https://www.youtube.com")) {
                alert("URL은 'https://www.youtube.com'으로 시작해야 합니다.");
                return;
            }
            else {
                newDivEle.appendChild(newDivChildEle1);
                newDivEle.appendChild(newDivChildEle2);
                newDivEle.appendChild(newDivChildEle3);
            }    
            $container.insertBefore(newDivEle,addEle);

            let savedData = JSON.parse(localStorage.getItem("boxData")) || [];
            savedData.push(newDivEle.innerHTML);
            // console.log(savedData);
            localStorage.setItem("boxData", JSON.stringify(savedData));
        }

        function deleteBox(e) {
            let savedData = JSON.parse(localStorage.getItem("boxData")) || [];
            const clickedDiv = e.currentTarget.parentNode;
            deleteLocalStorage(clickedDiv);
            // const parent = clickedDiv.parentNode;
            // const childs = parent.querySelectorAll('.box');
            // const divs = Array.from(childs);
            // const index = divs.indexOf(clickedDiv);
            // const boxData = JSON.parse(localStorage.getItem("boxData"));
            // delete boxData[index];
            // const filterArr = boxData.filter(item => item !== null || item!==undefined);
            // localStorage.setItem("boxData", JSON.stringify(filterArr));
            clickedDiv.remove();
        }

        function deleteLocalStorage(one) {
            const parentNode = one.parentNode;
            const childs = parentNode.querySelectorAll('.box');
            const divs = Array.from(childs);
            const index = divs.indexOf(one);
            const boxData = JSON.parse(localStorage.getItem("boxData"));
            delete boxData[index];
            const filterArr = boxData.filter(item => item !== null || item!==undefined);
            localStorage.setItem("boxData", JSON.stringify(filterArr));
        }

        addEle.addEventListener('click', showModal);
        submitBtn.addEventListener('click', closeModal);
        closeBtn.addEventListener('click',closeModal);

        window.addEventListener('click', function(e){
            if(e.target === modal) {
                closeModal();
                clearInput()
            }
        })



            
      </script>
</body>
</html>